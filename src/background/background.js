var propertyType = {
    residential: 1,
    land: 3
};
var priceMin = 0;
var priceMax = 300000;

var listings = [];
chrome.storage.sync.get('listings', function(listingsData) {
    if (listingsData.listings) {
        listings = listingsData.listings;
    }
});
chrome.storage.onChanged.addListener(function(changes) {
    if (changes.listings) {
        var storageChange = changes.listings;
        listings = storageChange.newValue;
    }
});

var remoteUrl = 'http://www.utahrealestate.com/search/chained.update/count/true/criteria/false/pg/1/limit/50';
var data = {
    param: 'geometry',
    value: 'POLYGON((-112.62406289581911 39.39803897656315,-112.62406289581911 39.39817162867565,-112.62474954132446 39.39843693214322,-112.62526452545346 39.39883488545303,-112.6259511709678 39.39923283649256,-112.62646615509682 39.39963078526178,-112.62732446197849 39.40002873176073,-112.62801110748384 39.40042667598934,-112.6288694143745 39.400559323561254,-112.63007104400886 39.40122255763563,-112.63110101227586 39.401620495053294,-112.63213098053389 39.401753140354906,-112.63316094880088 39.402018430200634,-112.63401925568256 39.402151074745476,-112.6347059011879 39.402151074745476,-112.63573586945492 39.402151074745476,-112.63625085358392 39.402151074745476,-112.63710916046561 39.402151074745476,-112.63728082184196 39.402151074745476,-112.63779580597095 39.402151074745476,-112.63813912873263 39.402151074745476,-112.63831079010895 39.402151074745476,-112.63916909699063 39.402151074745476,-112.640370726625 39.402151074745476,-112.64174401764465 39.402018430200634,-112.64277398590268 39.401885785404254,-112.64397561554603 39.40148784950014,-112.64483392242772 39.40122255763563,-112.64586389069471 39.40082461794765,-112.64637887482372 39.400691970880935,-112.64706552032905 39.40029402816586,-112.64740884308172 39.40002873176073,-112.64792382721075 39.39963078526178,-112.64809548858707 39.39923283649256,-112.64861047272507 39.39883488545303,-112.64895379547774 39.39830428053521,-112.6491254568541 39.39764101871278,-112.64946877960676 39.39711040471387,-112.64964044098309 39.39631447614835,-112.64964044098309 39.395518538501804,-112.64998376373576 39.394457274180084,-112.64998376373576 39.39366131534476,-112.64998376373576 39.392865347428625,-112.64998376373576 39.39206937043173,-112.65015542511209 39.391140719124756,-112.65015542511209 39.38994672071192,-112.65015542511209 39.38888537163739,-112.64998376373576 39.3876913346315,-112.64981210235943 39.386497277195296,-112.64946877960676 39.38517052274831,-112.64946877960676 39.38371106372451,-112.64929711823042 39.38238425630946,-112.64895379547774 39.38092473902064,-112.64895379547774 39.37933250353572,-112.64895379547774 39.37800561288716,-112.64895379547774 39.37641331081643,-112.64895379547774 39.3749536686793,-112.64878213410142 39.37336129699763,-112.64878213410142 39.37203429285292,-112.64878213410142 39.37044185458823,-112.64878213410142 39.36898208760865,-112.64878213410142 39.367389579735175,-112.64878213410142 39.36606246209907,-112.64843881134874 39.36446988764605,-112.6482671499724 39.36300999582848,-112.6482671499724 39.361417351769575,-112.64792382721075 39.36009012064744,-112.6477521658344 39.35863013728462,-112.64740884308172 39.35743558274612,-112.6472371817054 39.356108275968104,-112.64689385895272 39.35491367830675,-112.64672219757638 39.35411726851786,-112.64637887482372 39.352922636812,-112.64586389069471 39.35172798468075,-112.64569222931839 39.35066605452777,-112.64517724518036 39.349736852404554,-112.64483392242772 39.34854214580462,-112.6443189382987 39.34748016723469,-112.64414727692237 39.346550922748264,-112.64363229279334 39.345488913918764,-112.64311730865535 39.344559642954685,-112.64260232452635 39.34376311515146,-112.64208734039734 39.3427010639599,-112.64122903351566 39.34190451497553,-112.64054238800132 39.3411079569129,-112.63968408111964 39.34031138977347,-112.63951241974333 39.33978033997126,-112.6386541128616 39.339116522044094,-112.63813912873263 39.338718228262266,-112.63745248321828 39.3383199322111,-112.63659417633662 39.33792163389062,-112.63590753083126 39.33752333330078,-112.6350492239406 39.33712503044165,-112.63436257843524 39.33699226231743,-112.63384759430623 39.336726725313206,-112.63281762603924 39.33632841791545,-112.63195931915754 39.336195648278355,-112.63127267365219 39.335930108248384,-112.63092935089952 39.335930108248384,-112.6302427053852 39.33579733785485,-112.62972772125617 39.33553179631205,-112.6293843985035 39.33553179631205,-112.62869775299816 39.335399025162076,-112.62783944610749 39.33513348210641,-112.62715280060216 39.33500071020002,-112.62629449372047 39.33473516563079,-112.62560784820616 39.33460239296868,-112.62474954132446 39.33433684688659,-112.62406289581911 39.33433684688659,-112.62320458893741 39.334204073468044,-112.62251794342309 39.334204073468044,-112.62148797516508 39.33393852587314,-112.61942803864007 39.33380575169815,-112.61839807038204 39.33354020259039,-112.61702477936235 39.33354020259039,-112.616338133857 39.33340742765902,-112.61547982696634 39.33314187703841,-112.614793181461 39.33314187703841,-112.614278197332 39.33314187703841,-112.61341989045032 39.33314187703841,-112.61324822907397 39.333274652474806,-112.61290490631232 39.333274652474806,-112.61273324493598 39.333274652474806,-112.6123899221833 39.33354020259039,-112.6118749380543 39.333672977270346,-112.61135995392529 39.33393852587314,-112.61118829254896 39.334071299796655,-112.61067330841993 39.33433684688659,-112.61015832428194 39.33473516563079,-112.60930001740027 39.33513348210641,-112.60861337189492 39.33553179631205,-112.60809838775693 39.3360628783891,-112.60758340362791 39.336726725313206,-112.60706841949892 39.33725779831374,-112.6065534353699 39.33792163389062,-112.60621011261722 39.338452697813885,-112.60569512848822 39.339116522044094,-112.6055234671029 39.33964757688997,-112.6050084829739 39.340444151593985,-112.60449349884487 39.34124071722049,-112.60397851471585 39.34203727376951,-112.60346353058685 39.34283382124095,-112.60294854644886 39.34363035963481,-112.60243356231986 39.344426888951666,-112.60191857819086 39.345223409190126,-112.60140359406184 39.346019920350805,-112.60088860993282 39.34681642243366,-112.60037362579484 39.34748016723469,-112.60003030304215 39.34827665267478,-112.59951531891315 39.348807637925084,-112.5993436575368 39.3494713638144,-112.59882867340781 39.350002339986034,-112.59848535065514 39.35066605452777,-112.59797036651713 39.351197021621964,-112.59779870514079 39.35186072481538,-112.59779870514079 39.3522589437055,-112.59728372101179 39.35305537467706,-112.59728372101179 39.35385179657036,-112.59694039825912 39.35464820938536,-112.5967687368828 39.3555773461957,-112.5964254141301 39.35637373934085,-112.5964254141301 39.35743558274612,-112.5964254141301 39.35823195470809,-112.5964254141301 39.3591610438563,-112.5964254141301 39.35995739614791,-112.5964254141301 39.360753739360845,-112.5964254141301 39.361550073495025,-112.5964254141301 39.36234639855041,-112.59659707550644 39.36300999582848,-112.59694039825912 39.36380630423927,-112.59694039825912 39.3643371714695,-112.59711205963544 39.365000749832404,-112.59711205963544 39.36553160798364,-112.59711205963544 39.36619517499777,-112.59745538238813 39.366726024069955,-112.59762704376446 39.367389579735175,-112.59797036651713 39.36792041972819,-112.59814202790245 39.36858396404446,-112.59848535065514 39.3693802089023,-112.59865701203145 39.37017644468015,-112.59917199616048 39.37097267137865,-112.59951531891315 39.37176888899777,-112.60003030304215 39.372565097537446,-112.6002019644185 39.37336129699763,-112.60054528717117 39.373759393322885,-112.60106027130914 39.37455557916373,-112.60123193268552 39.37508636468029,-112.60157525543816 39.375749840901385,-112.60174691681452 39.3761479236072,-112.60209023956719 39.376678697016814,-112.60226190094352 39.37734215810504,-112.60260522369622 39.377872922435564,-112.60312020782521 39.37853637217332,-112.60329186921051 39.37906712742403,-112.60380685333952 39.37973056581192,-112.60432183746855 39.3802613119827,-112.60483682159754 39.38092473902064,-112.60535180572654 39.3814554761114,-112.60586678986456 39.3821188918,-112.60621011261722 39.38251693818617,-112.60672509674623 39.38304766316945,-112.60724008087526 39.383445704258904,-112.60775506500426 39.38384374307828,-112.60792672638061 39.38424177962764,-112.60844171051858 39.38490516883242,-112.60878503327127 39.385303199328256,-112.60930001740027 39.385701227553994,-112.6094716787766 39.386231928324015,-112.60998666290561 39.38689529861081,-112.61050164703461 39.38742599030042,-112.6110166311726 39.3880893492367,-112.61153161530163 39.38862003184588,-112.61204659943063 39.38901804115412,-112.61256158355965 39.389416048192224,-112.61307656768865 39.389814052960176,-112.61341989045032 39.390212055458,-112.61393487457931 39.390875387910036,-112.61444985870834 39.39127338435409,-112.61496484283734 39.391671378528,-112.6151365042137 39.39206937043173,-112.61565148835166 39.392202033895394,-112.61599481110436 39.39260002277221,-112.61616647248069 39.392865347428625,-112.61650979523336 39.392998009378836,-112.61650979523336 39.3932633325218,-112.6166814566097 39.3932633325218,-112.6166814566097 39.39339599371526,-112.61702477936235 39.39366131534476,-112.6171964407387 39.393793975781506,-112.6171964407387 39.39405929589752,-112.61753976349138 39.394191955577526,-112.6177114248677 39.394457274180084,-112.61805474762039 39.39458993310332,-112.62406289581911 39.39803897656315))',
    chain: 'saveLocation,criteriaAndCountAction,mapInlineResultsAction',
    all: 1,
    type: propertyType.residential,
    listprice1: priceMin,
    listprice2: priceMax,
    stat: '1,2',
    status: '1,2'
};

var returnFunction = function(data) {
    var changed = false;
    var added = false;
    _.forEach(data.markers, function(listingData) {
        var oldListing = _.find(listings, {id: listingData.id});

        if (!oldListing) {
            changed = true;
            added = true;
            var listing = {
                id: listingData.id,
                lat: listingData.lat,
                long: listingData.long,
                price: listingData.price,
                status: 'new',
                date: new Date()
            };
            listings.push(listing);
        } else if (oldListing.price != listingData.price) {
            changed = true;
            added = true;
            oldListing.price = listingData.price;
            oldListing.status = 'price';
            oldListing.date = new Date();
        }
    });

    var deadDate = new Date();
    deadDate.setDate(deadDate.getDate() - 14);

    var filteredListings = _.filter(listings, function(listing) {
        var old = listing.date < deadDate;
        return !old;
    });

    if (listings.length != filteredListings.length) {
        changed = true;
        listings = filteredListings;
    }

    if (changed) {
        chrome.storage.sync.set({
            listings: listings
        });
    }

    if (added) {
        chrome.browserAction.setIcon({
            path: {
                "32": '../../images/icon-new.png'
            }
        });
    }
};

$.post(remoteUrl, data, returnFunction, 'json');
setInterval(function() {
    $.post(remoteUrl, data, returnFunction, 'json');
}, 5 * 60 * 1000);
